<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001" author="cashflow-service">
        <comment>Create initial schema for Cash Flow Management Service</comment>
        
        <!-- Create schema -->
        <sql>
            IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'cashflow')
            BEGIN
                EXEC('CREATE SCHEMA cashflow')
            END
        </sql>

        <!-- Create cash_flows table -->
        <createTable tableName="cash_flows">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cash_flow_id" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="lot_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_basis" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="accrual_start_date" type="DATE"/>
            <column name="accrual_end_date" type="DATE"/>
            <column name="settlement_date" type="DATE"/>
            <column name="metadata" type="NVARCHAR(MAX)"/>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Create settlement_instructions table -->
        <createTable tableName="settlement_instructions">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="settlement_id" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_method" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="reference_number" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="bank_name" type="VARCHAR(200)"/>
            <column name="account_number" type="VARCHAR(50)"/>
            <column name="routing_number" type="VARCHAR(50)"/>
            <column name="swift_code" type="VARCHAR(20)"/>
            <column name="iban" type="VARCHAR(50)"/>
            <column name="account_from" type="VARCHAR(100)"/>
            <column name="account_to" type="VARCHAR(100)"/>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Create calculation_requests table -->
        <createTable tableName="calculation_requests">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="from_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="to_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="input_data_hash" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="input_data_snapshot" type="NVARCHAR(MAX)"/>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_count" type="INT"/>
            <column name="settlement_count" type="INT"/>
            <column name="total_amount" type="DECIMAL(19,4)"/>
            <column name="currency" type="VARCHAR(3)"/>
            <column name="calculation_duration" type="BIGINT"/>
            <column name="error_message" type="NVARCHAR(MAX)"/>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add default values for created_at and updated_at -->
        <sql>
            ALTER TABLE cashflow.cash_flows 
            ADD CONSTRAINT DF_cash_flows_created_at DEFAULT GETDATE() FOR created_at;
            
            ALTER TABLE cashflow.cash_flows 
            ADD CONSTRAINT DF_cash_flows_updated_at DEFAULT GETDATE() FOR updated_at;
            
            ALTER TABLE cashflow.settlement_instructions 
            ADD CONSTRAINT DF_settlement_instructions_created_at DEFAULT GETDATE() FOR created_at;
            
            ALTER TABLE cashflow.settlement_instructions 
            ADD CONSTRAINT DF_settlement_instructions_updated_at DEFAULT GETDATE() FOR updated_at;
            
            ALTER TABLE cashflow.calculation_requests 
            ADD CONSTRAINT DF_calculation_requests_created_at DEFAULT GETDATE() FOR created_at;
            
            ALTER TABLE cashflow.calculation_requests 
            ADD CONSTRAINT DF_calculation_requests_updated_at DEFAULT GETDATE() FOR updated_at;
        </sql>

    </changeSet>

</databaseChangeLog>
