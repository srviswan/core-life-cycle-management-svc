# Cash Flow Management Service

A high-performance, microservices-based cash flow calculation and management system designed for financial institutions handling synthetic swaps and equity derivatives.

## üöÄ Features

- **Pure Calculation Service** - No input data storage, only outputs and audit metadata
- **High Performance** - Designed for 1M daily position updates with sub-100ms response times
- **Real-time Processing** - Event-driven architecture with Kafka/Solace integration
- **Comprehensive Caching** - Redis-based caching with intelligent cache management
- **Audit Trail** - MS SQL Server temporal tables for complete history tracking
- **Scalable Architecture** - Containerized deployment with Kubernetes support
- **Monitoring** - Prometheus metrics and Grafana dashboards

## üèóÔ∏è Architecture

### Core Components

1. **Cash Flow Engine** - Core calculation logic for interest, dividend, P&L, and principal cash flows
2. **Settlement Service** - Generation of settlement instructions for realized cash flows
3. **Event Publisher** - Publishing events to messaging systems and ODS
4. **Cache Service** - Abstraction layer for Redis/caching operations
5. **Validation Service** - Request validation and business rule enforcement

### Technology Stack

- **Java 21** - Latest LTS with virtual threads support
- **Spring Boot 3.1** - Modern Spring framework
- **MS SQL Server** - Primary database with temporal tables
- **Redis** - Caching layer
- **Kafka/Solace** - Messaging infrastructure
- **Liquibase** - Database migration management
- **Docker** - Containerization
- **Prometheus/Grafana** - Monitoring and visualization

## üìã Prerequisites

- Java 21 JDK
- Maven 3.8+
- Docker & Docker Compose
- MS SQL Server (for production)
- Redis (for production)
- Kafka/Solace (for production)

## üõ†Ô∏è Installation

### Option 1: Docker Compose (Recommended for Development)

```bash
# Clone the repository
git clone <repository-url>
cd core-life-cycle-management-svc

# Start all services
docker-compose up -d

# Check service status
docker-compose ps

# View logs
docker-compose logs -f cash-flow-service
```

### Option 2: Traditional JAR Deployment

```bash
# Build the application
mvn clean package -DskipTests

# Run deployment script (requires root)
sudo ./deploy.sh install

# Check service status
sudo ./deploy.sh status

# View logs
sudo journalctl -u cash-flow-service -f
```

### Option 3: Manual JAR Execution

```bash
# Build the application
mvn clean package -DskipTests

# Run with default configuration
java -jar target/cash-flow-management-service-1.0.0-SNAPSHOT.jar

# Run with custom configuration
java -jar target/cash-flow-management-service-1.0.0-SNAPSHOT.jar \
  --spring.config.location=file:./config/application.yml
```

## üß™ Testing

### Unit Tests

```bash
# Run all unit tests
mvn test

# Run specific test class
mvn test -Dtest=CashFlowCalculationServiceTest

# Run tests with coverage
mvn test jacoco:report
```

### Integration Tests

```bash
# Run integration tests (requires Docker)
mvn test -Dtest=*IntegrationTest

# Run performance tests
mvn test -Dtest=*PerformanceTest
```

### Load Testing

```bash
# Start the service
docker-compose up -d

# Run performance tests
mvn test -Dtest=*PerformanceTest

# Monitor metrics
curl http://localhost:8080/actuator/metrics
```

## üìä Monitoring

### Access Monitoring Tools

- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)
- **Service Health**: http://localhost:8080/api/v1/cashflows/health
- **Actuator**: http://localhost:8080/actuator

### Key Metrics

- HTTP request rate and response times
- JVM memory usage
- Cache hit rates
- Active calculation count
- Database connection pool status

## üîß Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_HOST` | Database host | `localhost` |
| `DB_PORT` | Database port | `1433` |
| `DB_NAME` | Database name | `cashflow_db` |
| `DB_USERNAME` | Database username | `sa` |
| `DB_PASSWORD` | Database password | `YourStrong@Passw0rd` |
| `REDIS_HOST` | Redis host | `localhost` |
| `REDIS_PORT` | Redis port | `6379` |
| `KAFKA_BOOTSTRAP_SERVERS` | Kafka servers | `localhost:9092` |
| `SERVER_PORT` | Service port | `8080` |

### Application Properties

Key configuration options in `application.yml`:

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  cache:
    redis:
      timeout: 2000ms
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.xml
```

## üìö API Documentation

### Swagger UI

Access the interactive API documentation at:
http://localhost:8080/swagger-ui.html

### Key Endpoints

- `POST /api/v1/cashflows/calculate` - Calculate cash flows
- `POST /api/v1/cashflows/calculate/batch` - Batch calculation
- `POST /api/v1/cashflows/recalculate` - Recalculate with date range
- `GET /api/v1/cashflows/cached/{requestId}` - Get cached result
- `GET /api/v1/cashflows/health` - Health check

### Example Request

```json
{
  "requestId": "REQ_001",
  "contractId": "SWAP_IBM_001",
  "dateRange": {
    "fromDate": "2025-08-01",
    "toDate": "2025-08-31",
    "calculationFrequency": "DAILY"
  },
  "contract": {
    "contractId": "SWAP_IBM_001",
    "contractType": "EQUITY_SWAP",
    "notionalAmount": 1000000.00,
    "currency": "USD",
    "startDate": "2025-08-01",
    "endDate": "2026-08-01",
    "interestRate": 0.05
  },
  "positions": [...],
  "lots": [...],
  "marketData": [...]
}
```

## üóÑÔ∏è Database

### Schema

The service uses three main tables:

1. **cash_flows** - Cash flow records with temporal tracking
2. **settlement_instructions** - Settlement instructions with natural keys
3. **calculation_requests** - Audit trail for calculations

### Migrations

Database migrations are managed by Liquibase:

```bash
# Check migration status
curl http://localhost:8080/actuator/liquibase

# Manual migration (if needed)
java -jar app.jar --liquibase.migrate
```

## üîí Security

### Production Considerations

1. **Database Security**
   - Use strong passwords
   - Enable encryption
   - Implement connection pooling limits

2. **Network Security**
   - Use HTTPS in production
   - Implement API authentication
   - Restrict network access

3. **Application Security**
   - Run as non-root user
   - Use secrets management
   - Enable audit logging

## üöÄ Performance

### Performance Targets

- **Single Calculation**: < 100ms
- **Batch Processing**: < 3 seconds for 50 requests
- **Concurrent Load**: 500 requests under 15 seconds
- **Memory Usage**: < 100MB additional under load
- **Cache Hit Rate**: > 95% for repeated calculations

### Optimization Tips

1. **Database**
   - Use appropriate indexes
   - Monitor query performance
   - Implement connection pooling

2. **Caching**
   - Tune cache TTL settings
   - Monitor cache hit rates
   - Use cache warming strategies

3. **JVM**
   - Use G1GC garbage collector
   - Tune heap sizes
   - Enable container support

## üêõ Troubleshooting

### Common Issues

1. **Database Connection**
   ```bash
   # Check database connectivity
   docker-compose logs sqlserver
   ```

2. **Service Startup**
   ```bash
   # Check service logs
   docker-compose logs cash-flow-service
   ```

3. **Performance Issues**
   ```bash
   # Check metrics
   curl http://localhost:8080/actuator/metrics
   ```

### Log Analysis

Logs are available at:
- Docker: `docker-compose logs cash-flow-service`
- Traditional: `journalctl -u cash-flow-service`

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üìû Support

For support and questions:
- Create an issue in the repository
- Contact the development team
- Check the documentation

---

**Note**: This service is designed for production use in financial institutions. Ensure proper testing and validation before deployment in production environments.
