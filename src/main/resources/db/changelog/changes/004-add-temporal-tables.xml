<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="004" author="cashflow-service">
        <comment>Add temporal tables for audit trail</comment>
        
        <!-- Add temporal columns to cash_flows table -->
        <addColumn tableName="cash_flows" schemaName="cashflow">
            <column name="SysStartTime" type="DATETIME2" defaultValueComputed="GETUTCDATE()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="cash_flows" schemaName="cashflow">
            <column name="SysEndTime" type="DATETIME2" defaultValueComputed="CONVERT(DATETIME2, '9999-12-31 23:59:59.9999999')">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Create history table for cash_flows -->
        <createTable tableName="cash_flows_history" schemaName="cashflow">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="lot_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_basis" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="accrual_start_date" type="DATE"/>
            <column name="accrual_end_date" type="DATE"/>
            <column name="settlement_date" type="DATE"/>
            <column name="metadata" type="NVARCHAR(MAX)"/>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SysStartTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="SysEndTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Enable temporal table for cash_flows -->
        <sql>
            ALTER TABLE cash_flows 
            ADD PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime);
            
            ALTER TABLE cash_flows 
            SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = cash_flows_history));
        </sql>

        <!-- Add temporal columns to settlement_instructions table -->
        <addColumn tableName="settlement_instructions" schemaName="cashflow">
            <column name="SysStartTime" type="DATETIME2" defaultValueComputed="GETUTCDATE()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="settlement_instructions" schemaName="cashflow">
            <column name="SysEndTime" type="DATETIME2" defaultValueComputed="CONVERT(DATETIME2, '9999-12-31 23:59:59.9999999')">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Create history table for settlement_instructions -->
        <createTable tableName="settlement_instructions_history" schemaName="cashflow">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="settlement_method" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="reference_number" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="bank_name" type="VARCHAR(200)"/>
            <column name="account_number" type="VARCHAR(50)"/>
            <column name="routing_number" type="VARCHAR(50)"/>
            <column name="swift_code" type="VARCHAR(20)"/>
            <column name="iban" type="VARCHAR(50)"/>
            <column name="account_from" type="VARCHAR(100)"/>
            <column name="account_to" type="VARCHAR(100)"/>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SysStartTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="SysEndTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Enable temporal table for settlement_instructions -->
        <sql>
            ALTER TABLE settlement_instructions 
            ADD PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime);
            
            ALTER TABLE settlement_instructions 
            SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = settlement_instructions_history));
        </sql>

        <!-- Add temporal columns to calculation_requests table -->
        <addColumn tableName="calculation_requests" schemaName="cashflow">
            <column name="SysStartTime" type="DATETIME2" defaultValueComputed="GETUTCDATE()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="calculation_requests" schemaName="cashflow">
            <column name="SysEndTime" type="DATETIME2" defaultValueComputed="CONVERT(DATETIME2, '9999-12-31 23:59:59.9999999')">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Create history table for calculation_requests -->
        <createTable tableName="calculation_requests_history" schemaName="cashflow">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="request_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="contract_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="from_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="to_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="calculation_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="input_data_hash" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="input_data_snapshot" type="NVARCHAR(MAX)"/>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="cash_flow_count" type="INT"/>
            <column name="settlement_count" type="INT"/>
            <column name="total_amount" type="DECIMAL(19,4)"/>
            <column name="currency" type="VARCHAR(3)"/>
            <column name="calculation_duration" type="BIGINT"/>
            <column name="error_message" type="NVARCHAR(MAX)"/>
            <column name="created_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SysStartTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
            <column name="SysEndTime" type="DATETIME2">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Enable temporal table for calculation_requests -->
        <sql>
            ALTER TABLE calculation_requests 
            ADD PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime);
            
            ALTER TABLE calculation_requests 
            SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = calculation_requests_history));
        </sql>

    </changeSet>

</databaseChangeLog>
